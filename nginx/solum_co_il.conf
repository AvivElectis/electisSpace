# =====================================================================
# solum.co.il — Full nginx virtual host configuration
# =====================================================================
# Location on Windows Server: C:\nginx\conf\vhosts\solum_co_il.conf
# Last updated: 2026-02-13 (v2.1.0 merge)
# =====================================================================

server {
    listen       80;
    server_name  solum.co.il www.solum.co.il;
    return       301 https://$host$request_uri;
}

server {
    listen              443 ssl;
    server_name         solum.co.il www.solum.co.il;
    http2 on;

    ssl_certificate     C:/nginx/certs/solum/fullchain.pem;
    ssl_certificate_key C:/nginx/certs/solum/sol.pem;
    include             C:/nginx/conf/ssl-params.conf;

    # =============================================
    # electisSpace API — /app/api/* (MUST come first - most specific)
    # =============================================
    location /app/api/ {
        proxy_pass         http://127.0.0.1:4000/api/;
        proxy_http_version 1.1;

        # Standard proxy headers
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";

        # SSE (Server-Sent Events) support — CRITICAL
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;

        # File uploads
        client_max_body_size 10m;
    }

    # =============================================
    # electisSpace Static Assets — /app/assets/*
    # =============================================
    location /app/assets/ {
        alias C:/electisSpace/dist/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # =============================================
    # electisSpace Frontend — /app/
    # =============================================
    location /app/ {
        alias C:/electisSpace/dist/;
        index index.html;
        try_files $uri $uri/ /app/index.html;
    }

    # Redirect /app to /app/
    location = /app {
        return 301 /app/;
    }

    # =============================================
    # Existing application on /
    # =============================================
    location / {
        proxy_pass         http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
    }
}
