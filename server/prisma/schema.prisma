// Enhanced Prisma Schema for electisSpace Server
// Multi-Company, Multi-Store with Enhanced Permissions
// PostgreSQL Database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ======================
// Companies (AIMS Organizations)
// ======================
model Company {
  id              String   @id @default(uuid())
  
  // Company Identity
  name            String   @db.VarChar(100)
  code            String   @unique @db.VarChar(20)  // 3+ capital letters, AIMS unique identifier
  location        String?  @db.VarChar(255)
  description     String?  @db.Text
  
  // AIMS API Configuration (encrypted in application layer)
  aimsBaseUrl     String?  @map("aims_base_url") @db.VarChar(255)
  aimsCluster     String?  @map("aims_cluster") @db.VarChar(50)
  aimsUsername    String?  @map("aims_username") @db.VarChar(255)
  aimsPasswordEnc String?  @map("aims_password_enc") @db.Text
  
  // Company-wide settings
  settings        Json     @default("{}")
  isActive        Boolean  @default(true) @map("is_active")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  stores          Store[]
  userCompanies   UserCompany[]
  
  @@map("companies")
}

// ======================
// Stores (AIMS Store Numbers)
// ======================
model Store {
  id          String   @id @default(uuid())
  companyId   String   @map("company_id")
  
  // Store Identity
  name        String   @db.VarChar(100)
  code        String   @db.VarChar(10)  // Numeric string: "01", "002", "200"
  
  // Store-specific settings
  settings    Json     @default("{}")
  timezone    String   @default("UTC") @db.VarChar(50)
  syncEnabled Boolean  @default(true) @map("sync_enabled")
  lastAimsSyncAt DateTime? @map("last_aims_sync_at")
  isActive    Boolean  @default(true) @map("is_active")
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userStores      UserStore[]
  spaces          Space[]
  people          Person[]
  conferenceRooms ConferenceRoom[]
  peopleLists     PeopleList[]
  auditLogs       AuditLog[]
  syncQueue       SyncQueueItem[]
  
  @@unique([companyId, code])
  @@index([companyId])
  @@map("stores")
}

// ======================
// Users
// ======================
model User {
  id           String      @id @default(uuid())
  email        String      @unique @db.VarChar(255)
  passwordHash String      @map("password_hash") @db.VarChar(255)
  firstName    String?     @map("first_name") @db.VarChar(100)
  lastName     String?     @map("last_name") @db.VarChar(100)
  phone        String?     @db.VarChar(50)
  avatarUrl    String?     @map("avatar_url") @db.VarChar(500)
  
  // Global role (for platform-wide admins only)
  globalRole   GlobalRole? @map("global_role")
  
  // Active context (last selected company/store)
  activeCompanyId String? @map("active_company_id")
  activeStoreId   String? @map("active_store_id")
  
  // User status and activity tracking
  isActive     Boolean     @default(true) @map("is_active")
  lastLogin    DateTime?   @map("last_login")
  lastActivity DateTime?   @map("last_activity")  // Last API activity
  loginCount   Int         @default(0) @map("login_count")
  failedLoginAttempts Int  @default(0) @map("failed_login_attempts")
  lockedUntil  DateTime?   @map("locked_until")   // Account lock after failed attempts
  
  // Password management
  passwordChangedAt DateTime? @map("password_changed_at")
  passwordResetRequired Boolean @default(false) @map("password_reset_required")
  
  // User preferences (JSON)
  preferences  Json        @default("{}")  // UI preferences, notifications, etc.
  
  // Timestamps
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  
  // Relations
  userCompanies      UserCompany[]
  userStores         UserStore[]
  refreshTokens      RefreshToken[]
  verificationCodes  VerificationCode[]
  auditLogs          AuditLog[]
  createdSpaces      Space[]        @relation("SpaceCreatedBy")
  updatedSpaces      Space[]        @relation("SpaceUpdatedBy")
  createdLists       PeopleList[]
  
  @@map("users")
}

enum GlobalRole {
  PLATFORM_ADMIN
}

// ======================
// User-Company Access (Many-to-Many)
// ======================
model UserCompany {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")
  companyId       String      @map("company_id")
  role            CompanyRole @default(VIEWER)
  allStoresAccess Boolean     @default(false) @map("all_stores_access")  // If true, user has access to ALL stores in company
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("user_companies")
}

enum CompanyRole {
  SUPER_USER     // For PLATFORM_ADMIN - full access without restrictions
  COMPANY_ADMIN  // Can manage company settings, users, stores
  VIEWER         // Read-only access
}

// ======================
// User-Store Access (Many-to-Many with Roles)
// ======================
model UserStore {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  storeId   String    @map("store_id")
  role      StoreRole @default(STORE_VIEWER)
  
  // Feature permissions (JSON array of enabled features)
  // Available features: "spaces", "conference", "people", "dashboard"
  features  Json      @default("[\"dashboard\"]")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, storeId])
  @@index([userId])
  @@index([storeId])
  @@map("user_stores")
}

enum StoreRole {
  STORE_ADMIN
  STORE_MANAGER
  STORE_EMPLOYEE
  STORE_VIEWER
}

// ======================
// Refresh Tokens
// ======================
model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @map("token_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([tokenHash])
  @@index([userId])
  @@map("refresh_tokens")
}

// ======================
// Verification Codes (for 2FA and Password Reset)
// ======================
model VerificationCode {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  code      String   @db.VarChar(10)
  type      CodeType // LOGIN_2FA, PASSWORD_RESET
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, type, used])
  @@index([code])
  @@map("verification_codes")
}

enum CodeType {
  LOGIN_2FA
  PASSWORD_RESET
}

// ======================
// Spaces (Rooms/Desks/Chairs) - Store-scoped
// ======================
model Space {
  id           String     @id @default(uuid())
  storeId      String     @map("store_id")
  externalId   String     @map("external_id") @db.VarChar(50)
  labelCode    String?    @map("label_code") @db.VarChar(50)
  templateName String?    @map("template_name") @db.VarChar(100)
  
  // Dynamic data fields
  data         Json       @default("{}")
  
  // Sync status
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  lastSyncedAt DateTime?  @map("last_synced_at")
  
  // Audit
  createdById String? @map("created_by")
  updatedById String? @map("updated_by")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  store           Store                    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  createdBy       User?                    @relation("SpaceCreatedBy", fields: [createdById], references: [id])
  updatedBy       User?                    @relation("SpaceUpdatedBy", fields: [updatedById], references: [id])
  assignedPeople  Person[]
  listMemberships PeopleListMembership[]
  
  @@unique([storeId, externalId])
  @@index([storeId])
  @@index([labelCode])
  @@map("spaces")
}

// ======================
// People - Store-scoped
// ======================
model Person {
  id              String     @id @default(uuid())
  storeId         String     @map("store_id")
  externalId      String?    @map("external_id") @db.VarChar(50)
  virtualSpaceId  String?    @map("virtual_space_id") @db.VarChar(50)
  assignedSpaceId String?    @map("assigned_space_id")
  
  // Dynamic data fields
  data         Json       @default("{}")
  
  // Sync status
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  lastSyncedAt DateTime?  @map("last_synced_at")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  store           Store                    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  assignedSpace   Space?                   @relation(fields: [assignedSpaceId], references: [id])
  listMemberships PeopleListMembership[]
  
  @@index([storeId])
  @@index([assignedSpaceId])
  @@map("people")
}

// ======================
// Conference Rooms - Store-scoped
// ======================
model ConferenceRoom {
  id           String     @id @default(uuid())
  storeId      String     @map("store_id")
  externalId   String     @map("external_id") @db.VarChar(50)
  roomName     String     @map("room_name") @db.VarChar(100)
  labelCode    String?    @map("label_code") @db.VarChar(50)
  
  // Meeting status
  hasMeeting   Boolean  @default(false) @map("has_meeting")
  meetingName  String?  @map("meeting_name") @db.VarChar(255)
  startTime    String?  @map("start_time") @db.VarChar(10)
  endTime      String?  @map("end_time") @db.VarChar(10)
  participants String[] @default([])
  
  // Sync status
  syncStatus SyncStatus @default(PENDING) @map("sync_status")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  @@unique([storeId, externalId])
  @@index([storeId])
  @@map("conference_rooms")
}

// ======================
// People Lists - Store-scoped
// ======================
model PeopleList {
  id          String   @id @default(uuid())
  storeId     String   @map("store_id")
  name        String   @db.VarChar(100)
  storageName String   @map("storage_name") @db.VarChar(100)
  createdById String?  @map("created_by")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  store       Store                    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  createdBy   User?                    @relation(fields: [createdById], references: [id])
  memberships PeopleListMembership[]
  
  @@unique([storeId, storageName])
  @@index([storeId])
  @@map("people_lists")
}

// ======================
// People List Memberships (Many-to-Many)
// ======================
model PeopleListMembership {
  id        String   @id @default(uuid())
  personId  String   @map("person_id")
  listId    String   @map("list_id")
  spaceId   String?  @map("space_id")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  person Person     @relation(fields: [personId], references: [id], onDelete: Cascade)
  list   PeopleList @relation(fields: [listId], references: [id], onDelete: Cascade)
  space  Space?     @relation(fields: [spaceId], references: [id])
  
  @@unique([personId, listId])
  @@index([personId])
  @@index([listId])
  @@map("people_list_memberships")
}

// ======================
// Audit Logs
// ======================
model AuditLog {
  id         String   @id @default(uuid())
  storeId    String?  @map("store_id")
  userId     String?  @map("user_id")
  action     String   @db.VarChar(50)
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id")
  oldData    Json?    @map("old_data")
  newData    Json?    @map("new_data")
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent")
  
  // Permission context
  permissionChecked String? @map("permission_checked") @db.VarChar(100)
  wasAuthorized     Boolean @default(true) @map("was_authorized")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  store Store? @relation(fields: [storeId], references: [id])
  user  User?  @relation(fields: [userId], references: [id])
  
  @@index([storeId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ======================
// Sync Queue - Store-scoped
// ======================
model SyncQueueItem {
  id           String      @id @default(uuid())
  storeId      String      @map("store_id")
  entityType   String      @map("entity_type") @db.VarChar(50)
  entityId     String      @map("entity_id")
  action       String      @db.VarChar(20)
  payload      Json
  attempts     Int         @default(0)
  maxAttempts  Int         @default(5) @map("max_attempts")
  status       QueueStatus @default(PENDING)
  errorMessage String?     @map("error_message")
  scheduledAt  DateTime    @default(now()) @map("scheduled_at")
  processedAt  DateTime?   @map("processed_at")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  @@index([status, scheduledAt])
  @@index([storeId])
  @@map("sync_queue")
}

// ======================
// Enums
// ======================

enum SyncStatus {
  PENDING
  SYNCING
  SYNCED
  FAILED
}

enum QueueStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
