server {
    listen       80;
    server_name  solum.co.il www.solum.co.il;
    return       301 https://$host$request_uri;
}

server {
    listen              443 ssl;
    server_name         solum.co.il www.solum.co.il;
    http2 on;

    ssl_certificate     C:/nginx/certs/solum/fullchain.pem;
    ssl_certificate_key C:/nginx/certs/solum/sol.pem;
    include             C:/nginx/conf/ssl-params.conf;

    # =============================================
    # electisSpace Frontend — /app/
    # =============================================
    location /app/ {
        alias C:/electisSpace/dist/;
        try_files $uri $uri/ /app/index.html;

        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2?|ttf|eot)$ {
            alias C:/electisSpace/dist/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # Redirect /app to /app/
    location = /app {
        return 301 /app/;
    }

    # =============================================
    # electisSpace API — /app/api/*
    # =============================================
    location /app/api/ {
        proxy_pass         http://127.0.0.1:4000/api/;
        proxy_http_version 1.1;

        # Standard proxy headers
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";

        # SSE (Server-Sent Events) support — CRITICAL
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;

        # File uploads
        client_max_body_size 10m;
    }

    # =============================================
    # Existing application on /
    # =============================================
    location / {
        proxy_pass         http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
    }
}
